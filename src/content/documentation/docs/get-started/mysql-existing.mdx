import Npm from '@components/markdown/Npm.astro';
import Callout from '@components/markdown/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@components/markdown/Breadcrumbs.astro';

<Breadcrumbs/>

# Get Started with Drizzle and MySQL in existing project

<Prerequisites>  
  - You should have installed Drizzle ORM and [Drizzle kit](https://orm.drizzle.team/kit-docs/overview). You can do this by running the following command:
  <Npm>
    drizzle-orm 
    -D drizzle-kit
  </Npm>
</Prerequisites>

#### Basic file structure

This is the basic file structure of the project. In the `src/db` directory, we have database-related files including connection in `index.ts` and table definition in `schema.ts`. In `drizzle` folder there are sql migration file and snapshots.

```plaintext
ðŸ“¦ <project root>
 â”œ ðŸ“‚ drizzle
 â”œ ðŸ“‚ src
 â”‚   â”œ ðŸ“‚ db
 â”‚   â”‚  â”œ ðŸ“œ index.ts
 â”‚   â”‚  â”” ðŸ“œ schema.ts
 â”‚   â”” ðŸ“œ index.ts
 â”œ ðŸ“œ .env
 â”œ ðŸ“œ drizzle.config.ts
 â”œ ðŸ“œ package.json
 â”” ðŸ“œ tsconfig.json
```

#### Step 1 - Setup connection variables

Add connection url to your `.env` file:

```plaintext copy
DATABASE_URL=<YOUR_CONNECTION_URL>
```

#### Step 2 - Setup Drizzle config file

**Drizzle config** - a configuration file that is used by [Drizzle Kit](https://orm.drizzle.team/kit-docs/overview) and contains all the information about your database connection, migration folder and schema files.

Create a `drizzle.config.ts` file in the root of your project and add the following content:

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'mysql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### Step 3 - Introspect your database

Drizzle Kit provides a CLI command to introspect your database and generate a schema file with migrations. The schema file contains all the information about your database tables, columns, relations, and indices.

For example, you have such table in your database:

```sql copy
CREATE TABLE `users_table` (
	`id` serial AUTO_INCREMENT NOT NULL,
	`name` varchar(255) NOT NULL,
	`age` int NOT NULL,
	`email` varchar(255) NOT NULL,
	CONSTRAINT `users_table_id` PRIMARY KEY(`id`),
	CONSTRAINT `users_table_email_unique` UNIQUE(`email`)
);
```

Introspect your database:

```bash copy
npx drizzle-kit introspect
```

The result of introspection will be a `schema.ts` file, `meta` folder with snapshots of your database schema, sql file with the migration and `relations.ts` file for [relational queries](/docs/rqb).

Here is an example of the generated `schema.ts` file:

```typescript copy filename="src/db/schema.ts"
// table schema generated by introspection
import {
  mysqlTable,
  mysqlSchema,
  AnyMySqlColumn,
  primaryKey,
  unique,
  serial,
  varchar,
  int,
} from 'drizzle-orm/mysql-core';
import { sql } from 'drizzle-orm';

export const usersTable = mysqlTable(
  'users_table',
  {
    id: serial().notNull(),
    name: varchar({ length: 255 }).notNull(),
    age: int().notNull(),
    email: varchar({ length: 255 }).notNull(),
  },
  (table) => {
    return {
      usersTableId: primaryKey({ columns: [table.id], name: 'users_table_id' }),
      id: unique('id').on(table.id),
      usersTableEmailUnique: unique('users_table_email_unique').on(table.email),
    };
  },
);
```

Learn more about introspection in the [documentation](/kit-docs/commands#introspect--pull).

#### Step 4 - Transfer code to your actual schema file

We recommend transferring the generated code from `drizzle/schema.ts` and `drizzle/relations.ts` to the actual schema file. In this guide we transferred code to `src/db/schema.ts`. Generated files for schema and relations can be deleted. This way you can manage your schema in a more structured way.

<Callout type="warning">If you decided to continue working with generated `drizzle/schema.ts` file then you should update your `drizzle.config.ts` with proper schema path.</Callout>

#### Step 5 - Install the `mysql2` package

<Npm>
mysql2
</Npm>

#### Step 6 - Connect Drizzle ORM to the database

Create a `index.ts` file in the `src/db` directory and initialize the connection:

<CodeTabs items={['mysql2', 'mysql with config']}>
```typescript copy
import { drizzle } from "drizzle-orm";

const db = await drizzle("mysql2", process.env.DATABASE_URL);
```
```typescript copy
import { drizzle } from "drizzle-orm";

// You can specify any property from the mysql2 connection options
const db = await drizzle("mysql2", { connection:{ uri: process.env.DATABASE_URL }});
```
</CodeTabs>

If you need a synchronous connection, you can use our additional connection API, where you specify a driver connection and pass it to the Drizzle instance.
There're two ways you can connect to the MySQL with `mysql2` driver, either single `client` connection or a `pool`.

<CodeTabs items={['Client connection', 'Pool connection']}>
  ```typescript copy
  import { drizzle } from "drizzle-orm/mysql2";
  import mysql from "mysql2/promise";

  const connection = await mysql.createConnection({
    host: "host",
    user: "user",
    database: "database",
    ...
  });

  const db = drizzle(connection);
  ```
  ```typescript copy
  import { drizzle } from "drizzle-orm/mysql2";
  import mysql from "mysql2/promise";

  const poolConnection = mysql.createPool({
    host: "host",
    user: "user",
    database: "database",
    ...
  });

  const db = drizzle(poolConnection);
  ```
</CodeTabs>

<Callout type="warning" emoji="âš™ï¸">
  For the built in `migrate` function with DDL migrations we and drivers strongly encourage you to use single `client` connection.  

  For querying purposes feel free to use either `client` or `pool` based on your business demands.
</Callout>

#### Step 7 - Update your table schema (optional)

If you want to update your table schema, you can do it in the `schema.ts` file. For example, let's add a new column `phone` to the `users_table`:

```typescript copy filename="src/db/schema.ts" {20}
import {
  mysqlTable,
  mysqlSchema,
  AnyMySqlColumn,
  primaryKey,
  unique,
  serial,
  varchar,
  int,
} from 'drizzle-orm/mysql-core';
import { sql } from 'drizzle-orm';

export const usersTable = mysqlTable(
  'users_table',
  {
    id: serial('id').notNull(),
    name: varchar('name', { length: 255 }).notNull(),
    age: int('age').notNull(),
    email: varchar('email', { length: 255 }).notNull(),
    phone: varchar('phone', { length: 255 }),
  },
  (table) => {
    return {
      usersTableId: primaryKey({ columns: [table.id], name: 'users_table_id' }),
      id: unique('id').on(table.id),
      usersTableEmailUnique: unique('users_table_email_unique').on(table.email),
    };
  },
);
```

#### Step 8 - Applying changes to the database

You can generate migrations using `drizzle-kit generate` command and then apply them using the `drizzle-kit migrate` command.
Learn more about migration process in [documentation](/kit-docs/overview#schema-updates).

Generate migrations:

```bash copy
npx drizzle-kit generate
```

Apply migrations:

```bash copy
npx drizzle-kit migrate
```

Alternatively, you can push changes directly to the database using [Drizzle kit push command](/kit-docs/overview#prototyping-with-db-push):

```bash copy
npx drizzle-kit push
```

<Callout type="warning">Push command is good for situations where you need to quickly test new schema designs or changes in a local development environment, allowing for fast iterations without the overhead of managing migration files.</Callout>

#### Step 9 - Query the database

In `src/index.ts` file you can perform CRUD operations:

```typescript copy filename="src/index.ts"
import { eq } from 'drizzle-orm';
import { db } from './db';
import { usersTable } from './db/schema';

(async () => {
  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
    phone: '123-456-7890',
  };

  await db.insert(usersTable).values(user);

  const users = await db.select().from(usersTable);
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
    phone: string | null;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
})();
```